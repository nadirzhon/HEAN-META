name: CI (Orchestrator)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  verify-submodules:
    name: Verify Submodules
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Check submodule status
        run: |
          echo "=== Submodule Status ==="
          git submodule status
          echo ""
          echo "=== Verify directories exist ==="
          ls -d backend/ ios/ dashboard/ infra/
          echo ""
          echo "=== Verify key files ==="
          test -f backend/pyproject.toml && echo "backend/pyproject.toml OK"
          test -d ios/HEAN.xcodeproj && echo "ios/HEAN.xcodeproj OK"
          test -f dashboard/package.json && echo "dashboard/package.json OK"
          test -d infra/k8s && echo "infra/k8s OK"

  backend-lint:
    name: Backend Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: cd backend && pip install -e ".[dev]"
      - name: Ruff
        run: cd backend && ruff check src/
      - name: Mypy
        run: cd backend && mypy src/

  backend-test:
    name: Backend Test
    needs: backend-lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: cd backend && pip install -e ".[dev]"
      - name: Run tests
        run: cd backend && pytest tests/ -v --ignore=tests/test_bybit_http.py --ignore=tests/test_bybit_websocket.py --cov=src/hean --cov-report=xml
      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          file: backend/coverage.xml
          fail_ci_if_error: false

  dashboard-build:
    name: Dashboard Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: dashboard/package-lock.json
      - run: cd dashboard && npm ci
      - run: cd dashboard && npm run build
