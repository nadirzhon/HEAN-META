name: CI (Orchestrator)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  # PYTHONPATH for uv workspace packages
  HEAN_PYTHONPATH: packages/hean-core/src:packages/hean-exchange/src:packages/hean-portfolio/src:packages/hean-risk/src:packages/hean-execution/src:packages/hean-strategies/src:packages/hean-physics/src:packages/hean-intelligence/src:packages/hean-observability/src:packages/hean-symbiont/src:packages/hean-api/src:packages/hean-app/src

jobs:
  verify-submodules:
    name: Verify Submodules
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Check submodule status
        run: |
          echo "=== Submodule Status ==="
          git submodule status
          echo ""
          echo "=== Verify directories exist ==="
          ls -d backend/ ios/ dashboard/ infra/
          echo ""
          echo "=== Verify key files ==="
          test -f backend/pyproject.toml && echo "backend/pyproject.toml OK"
          test -d backend/packages/hean-core && echo "backend/packages/hean-core OK"
          test -d ios/HEAN.xcodeproj && echo "ios/HEAN.xcodeproj OK"
          test -f dashboard/package.json && echo "dashboard/package.json OK"
          test -d infra/k8s && echo "infra/k8s OK"

  backend-lint:
    name: Backend Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        working-directory: backend
        run: |
          pip install ruff mypy pydantic pydantic-settings aiohttp redis orjson numpy networkx psutil
          pip install websockets httpx fastapi uvicorn slowapi prometheus-client duckdb polars pyarrow
      - name: Ruff
        working-directory: backend
        run: ruff check packages/
      - name: Mypy
        working-directory: backend
        run: PYTHONPATH=${{ env.HEAN_PYTHONPATH }} mypy packages/ --ignore-missing-imports

  backend-test:
    name: Backend Test
    needs: backend-lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        working-directory: backend
        run: |
          pip install pydantic pydantic-settings aiohttp redis orjson numpy networkx psutil
          pip install websockets httpx fastapi uvicorn slowapi prometheus-client duckdb polars pyarrow
          pip install python-dotenv python-socketio
          pip install pytest pytest-asyncio pytest-cov
      - name: Run tests
        working-directory: backend
        run: |
          PYTHONPATH=${{ env.HEAN_PYTHONPATH }} pytest tests/ -v \
            --ignore=tests/test_bybit_http.py \
            --ignore=tests/test_bybit_websocket.py \
            --cov-report=xml
      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          file: backend/coverage.xml
          fail_ci_if_error: false

  dashboard-build:
    name: Dashboard Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: dashboard/package-lock.json
      - run: cd dashboard && npm ci
      - run: cd dashboard && npm run build
