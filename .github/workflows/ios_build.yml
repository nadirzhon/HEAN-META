name: iOS Build

on:
  push:
    branches: [main, develop]
    paths:
      - 'ios/**'
  pull_request:
    branches: [main, develop]
    paths:
      - 'ios/**'

jobs:
  build:
    name: Build & Test iOS
    runs-on: macos-latest
    defaults:
      run:
        working-directory: ios

    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_15.4.app/Contents/Developer

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Build
        run: |
          xcodebuild build \
            -project HEAN.xcodeproj \
            -scheme HEAN \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=latest' \
            -configuration Debug \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty || true

      - name: Run Tests
        run: |
          xcodebuild test \
            -project HEAN.xcodeproj \
            -scheme HEAN \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=latest' \
            -configuration Debug \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty || true

  # Placeholder: uncomment when Apple certs and provisioning profiles are set up
  # deploy:
  #   name: Deploy to TestFlight
  #   needs: build
  #   runs-on: macos-latest
  #   if: github.ref == 'refs/heads/main'
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Install Fastlane
  #       run: gem install fastlane
  #     - name: Build and Upload to TestFlight
  #       env:
  #         APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.ASC_KEY_ID }}
  #         APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
  #         APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.ASC_KEY_CONTENT }}
  #       run: |
  #         cd ios
  #         fastlane beta
