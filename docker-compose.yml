services:
  # Backend API
  api:
    image: hean-api:latest
    build:
      context: ./backend
      dockerfile: Dockerfile
      args:
        - BUILDKIT_INLINE_CACHE=1
    container_name: hean-api
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - TZ=UTC
      - PYTHONPATH=/app/packages/hean-core/src:/app/packages/hean-exchange/src:/app/packages/hean-portfolio/src:/app/packages/hean-risk/src:/app/packages/hean-execution/src:/app/packages/hean-strategies/src:/app/packages/hean-physics/src:/app/packages/hean-intelligence/src:/app/packages/hean-observability/src:/app/packages/hean-symbiont/src:/app/packages/hean-api/src:/app/packages/hean-app/src
      - PHYSICS_SOURCE=${PHYSICS_SOURCE:-redis}
      - BRAIN_SOURCE=${BRAIN_SOURCE:-redis}
      - RISK_SOURCE=${RISK_SOURCE:-redis}
      - MICROSERVICES_GROUP_PREFIX=${MICROSERVICES_GROUP_PREFIX:-hean-core}
      # Signal chain reliability — new feature config (all have safe defaults in HEANSettings)
      - DLQ_AUTO_RETRY_INTERVAL_S=${DLQ_AUTO_RETRY_INTERVAL_S:-10.0}
      - INFLIGHT_RESERVATION_TIMEOUT_S=${INFLIGHT_RESERVATION_TIMEOUT_S:-30.0}
      - RECONCILIATION_INTERVAL_S=${RECONCILIATION_INTERVAL_S:-60}
      - CLOSE_RETRY_MAX_ATTEMPTS=${CLOSE_RETRY_MAX_ATTEMPTS:-3}
      - CLOSE_RETRY_BASE_DELAY_S=${CLOSE_RETRY_BASE_DELAY_S:-1.0}
    volumes:
      - ./backend/packages:/app/packages:ro
      - ./logs:/app/logs
      - ./.env:/app/.env:ro
    # CRITICAL: workers=1 — TradingSystem uses in-process shared state (EventBus,
    # accounting, killswitch, InFlightTracker, DLQ). Multiple workers would create
    # independent TradingSystem instances (split-brain): API queries worker-1 while
    # trading happens in worker-2, showing stale positions/equity.
    # For horizontal scaling, deploy multiple containers (not multiple workers).
    command: uvicorn hean.api.main:app --host 0.0.0.0 --port 8000 --workers 1
    restart: unless-stopped
    ports:
      - "8000:8000"  # API endpoint
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    networks:
      - hean-network
    depends_on:
      redis:
        condition: service_healthy
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  # Redis for atomic state sharing between C++ and Python
  redis:
    image: redis:7-alpine
    container_name: hean-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - hean-network
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

  # SYMBIONT X - Bybit Testnet Live Trading (REAL DATA, NO SIMULATION)
  symbiont-testnet:
    image: hean-symbiont:latest
    build:
      context: ./backend
      dockerfile: Dockerfile.testnet
    container_name: hean-symbiont-testnet
    env_file:
      - .env           # base: all features, AI keys, strategies, intelligence
      - .env.symbiont  # override: testnet Bybit credentials + capital only
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONPATH=/app/packages/hean-core/src:/app/packages/hean-exchange/src:/app/packages/hean-portfolio/src:/app/packages/hean-risk/src:/app/packages/hean-execution/src:/app/packages/hean-strategies/src:/app/packages/hean-physics/src:/app/packages/hean-intelligence/src:/app/packages/hean-observability/src:/app/packages/hean-symbiont/src:/app/packages/hean-api/src:/app/packages/hean-app/src
      - TZ=UTC
      - BYBIT_TESTNET=true
      - REDIS_URL=redis://redis:6379/0
      # Signal chain reliability — new feature config (all have safe defaults in HEANSettings)
      - DLQ_AUTO_RETRY_INTERVAL_S=${DLQ_AUTO_RETRY_INTERVAL_S:-10.0}
      - INFLIGHT_RESERVATION_TIMEOUT_S=${INFLIGHT_RESERVATION_TIMEOUT_S:-30.0}
      - RECONCILIATION_INTERVAL_S=${RECONCILIATION_INTERVAL_S:-60}
      - CLOSE_RETRY_MAX_ATTEMPTS=${CLOSE_RETRY_MAX_ATTEMPTS:-3}
      - CLOSE_RETRY_BASE_DELAY_S=${CLOSE_RETRY_BASE_DELAY_S:-1.0}
    volumes:
      - ./backend/packages:/app/packages:ro  # hot-reload: edits applied on restart
      - ./logs:/app/logs
      - ./data:/app/data
    networks:
      - hean-network
    command: python live_testnet_real.py
    restart: unless-stopped
    depends_on:
      redis:
        condition: service_healthy
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "/app/healthcheck.sh"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  # ============================================
  # Collector - Market Data Ingestion from Bybit WS
  # ============================================
  collector:
    build:
      context: ./backend/services/collector
      dockerfile: Dockerfile
    container_name: hean-collector
    environment:
      - REDIS_URL=redis://redis:6379
      - BYBIT_WS=wss://stream-testnet.bybit.com/v5/public/linear
      - SYMBOLS=${TRADING_SYMBOLS:-BTCUSDT,ETHUSDT,SOLUSDT}
      - MAX_STREAM_LENGTH=1000
    networks:
      - hean-network
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python3", "-c", "import socket; s=socket.socket(); s.settimeout(3); s.connect(('redis', 6379)); s.close()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M

  # ============================================
  # Physics - Market Thermodynamics Calculations
  # ============================================
  physics:
    build:
      context: ./backend/services/physics
      dockerfile: Dockerfile
    container_name: hean-physics
    environment:
      - REDIS_URL=redis://redis:6379
      - SYMBOLS=${TRADING_SYMBOLS:-BTCUSDT,ETHUSDT,SOLUSDT}
      - LOOKBACK_WINDOW=100
      - MAX_STREAM_LENGTH=500
    networks:
      - hean-network
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python3", "-c", "import socket; s=socket.socket(); s.settimeout(3); s.connect(('redis', 6379)); s.close()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

  # ============================================
  # Brain - AI Decision Making (Claude + Rules)
  # ============================================
  brain:
    build:
      context: ./backend/services/brain
      dockerfile: Dockerfile
    container_name: hean-brain
    env_file:
      - .env
    environment:
      - REDIS_URL=redis://redis:6379
      - SYMBOLS=${TRADING_SYMBOLS:-BTCUSDT,ETHUSDT,SOLUSDT}
      - STRATEGIC_INTERVAL=30
      - MAX_STREAM_LENGTH=200
    networks:
      - hean-network
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python3", "-c", "import socket; s=socket.socket(); s.settimeout(3); s.connect(('redis', 6379)); s.close()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

  # ============================================
  # Risk - Iron-Clad Risk Management
  # ============================================
  risk-svc:
    build:
      context: ./backend/services/risk
      dockerfile: Dockerfile
    container_name: hean-risk-svc
    environment:
      - REDIS_URL=redis://redis:6379
      - INITIAL_CAPITAL=${INITIAL_CAPITAL:-10000}
      - MAX_DAILY_LOSS_PCT=2.0
      - MAX_WEEKLY_LOSS_PCT=5.0
      - MAX_TRADE_RISK_PCT=1.0
      - MAX_STREAM_LENGTH=200
    networks:
      - hean-network
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python3", "-c", "import socket; s=socket.socket(); s.settimeout(3); s.connect(('redis', 6379)); s.close()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M

  # ============================================
  # Oracle - Multi-Source Signal Fusion
  # ============================================
  oracle:
    build:
      context: ./backend/services/oracle
      dockerfile: Dockerfile
    container_name: hean-oracle
    environment:
      - REDIS_URL=redis://redis:6379
      - SYMBOLS=${TRADING_SYMBOLS:-BTCUSDT,ETHUSDT,SOLUSDT}
      - FUSION_INTERVAL=5
      - CONFIDENCE_THRESHOLD=0.6
      - MAX_STREAM_LENGTH=200
    networks:
      - hean-network
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python3", "-c", "import socket; s=socket.socket(); s.settimeout(3); s.connect(('redis', 6379)); s.close()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

  # ============================================
  # Dashboard — Next.js 15 Web UI (port 3001)
  # ============================================
  dashboard:
    build:
      context: ./dashboard
      dockerfile: Dockerfile
      args:
        - NEXT_PUBLIC_API_URL=http://localhost:8000/api/v1
        - NEXT_PUBLIC_WS_URL=ws://localhost:8000/ws
    container_name: hean-dashboard
    environment:
      - NODE_ENV=production
      # Server-side rewrite target (Next.js → api container inside Docker network)
      - BACKEND_URL=http://api:8000
    ports:
      - "3001:3001"
    networks:
      - hean-network
    depends_on:
      api:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3001"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

networks:
  hean-network:
    driver: bridge

volumes:
  redis-data:
