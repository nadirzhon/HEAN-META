# –¢–û–†–ì–û–í–´–ô –ë–û–¢ HEAN - –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

–î–∞—Ç–∞: 2026-01-28
–í–µ—Ä—Å–∏—è: 2.0
–°—Ç–∞—Ç—É—Å: ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

---

## üìã –û–ë–ó–û–† –ü–†–û–ë–õ–ï–ú

–ë—ã–ª–∏ –≤—ã—è–≤–ª–µ–Ω—ã –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –≤ —Ç–æ—Ä–≥–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ HEAN:

### ‚ùå –ü–†–û–ë–õ–ï–ú–´ –î–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø:

1. **–û—Ä–¥–µ—Ä–∞ –Ω–µ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –±–æ–ª–µ–µ —á–∞—Å–∞** - –ü–æ–∑–∏—Ü–∏–∏ –∑–∞–≤–∏—Å–∞—é—Ç –∏ –Ω–µ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
2. **–¢–æ—Ä–≥–æ–≤–ª—è –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç—Å—è** - –°–∏—Å—Ç–µ–º–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ
3. **–ú–µ—Ç–æ–¥—ã —Ç–æ—Ä–≥–æ–≤–ª–∏ –Ω–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É—é—Ç** - –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –Ω–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
4. **–ö–∞–ø–∏—Ç–∞–ª –ù–ï —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ—Ä–æ–≤–Ω—É** - –ù–µ—Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ–∂–¥—É —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º–∏

### ‚úÖ –†–ï–®–ï–ù–ò–Ø:

1. ‚úÖ **Position Monitor** - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –∑–∞–≤–∏—Å—à–∏—Ö –ø–æ–∑–∏—Ü–∏–π
2. ‚úÖ **Docker restart: unless-stopped** - –ù–µ–ø—Ä–µ—Ä—ã–≤–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å –∞–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–º
3. ‚úÖ **Event-driven Architecture** - –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ EventBus
4. ‚úÖ **Force Equal Allocation** - –û–ø—Ü–∏—è —Ä–∞–≤–Ω–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–∞–ø–∏—Ç–∞–ª–∞ (1/N)

---

## üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï #1: Position Monitor

### –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:
- –û—Ä–¥–µ—Ä–∞ –æ—Ç–º–µ–Ω—è–ª–∏—Å—å —á–µ—Ä–µ–∑ TTL, –Ω–æ **–ø–æ–∑–∏—Ü–∏–∏ –æ—Å—Ç–∞–≤–∞–ª–∏—Å—å –æ—Ç–∫—Ä—ã—Ç—ã–º–∏**
- –ï—Å–ª–∏ –æ—Ä–¥–µ—Ä —á–∞—Å—Ç–∏—á–Ω–æ –∏—Å–ø–æ–ª–Ω—è–ª—Å—è, –ø–æ–∑–∏—Ü–∏—è –∑–∞–≤–∏—Å–∞–ª–∞ –Ω–∞–≤—Å–µ–≥–¥–∞
- –ù–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è —Å—Ç–∞—Ä—ã—Ö –ø–æ–∑–∏—Ü–∏–π

### –†–µ—à–µ–Ω–∏–µ:
–°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç **PositionMonitor**, –∫–æ—Ç–æ—Ä—ã–π:
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–æ–∑—Ä–∞—Å—Ç –≤—Å–µ—Ö –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
- –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –ø–æ–∑–∏—Ü–∏–∏ —Å—Ç–∞—Ä—à–µ `max_hold_seconds` (15 –º–∏–Ω—É—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç **—Ä—ã–Ω–æ—á–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞** –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è
- –õ–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–∫—Ä—ã—Ç–∏—è –¥–ª—è –∞—É–¥–∏—Ç–∞

### –§–∞–π–ª—ã:

**–ù–æ–≤—ã–π —Ñ–∞–π–ª:**
```
src/hean/execution/position_monitor.py
```

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
```
src/hean/main.py:
  - –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç PositionMonitor
  - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤ __init__: self._position_monitor = PositionMonitor(...)
  - –ó–∞–ø—É—Å–∫ –≤ start(): await self._position_monitor.start()
  - –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤ stop(): await self._position_monitor.stop()

src/hean/config.py:
  - position_monitor_check_interval: int = 30 (—Å–µ–∫—É–Ω–¥—ã)
  - position_monitor_enabled: bool = True

src/hean/api/routers/trading.py:
  - GET /orders/positions/monitor/stats - API –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
```

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:

```python
# .env
MAX_HOLD_SECONDS=900  # 15 –º–∏–Ω—É—Ç (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
POSITION_MONITOR_CHECK_INTERVAL=30  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫
POSITION_MONITOR_ENABLED=true  # –í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–∑–∞–∫—Ä—ã—Ç–∏–µ
```

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ü–∏–∫–ª** –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑—Ä–∞—Å—Ç–∞** –≤—Å–µ—Ö –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π
3. –ï—Å–ª–∏ –ø–æ–∑–∏—Ü–∏—è —Å—Ç–∞—Ä—à–µ 15 –º–∏–Ω—É—Ç:
   - **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: `FORCE-CLOSING stale position`
   - **–°–æ–∑–¥–∞–Ω–∏–µ market order** –Ω–∞ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—É—é —Å—Ç–æ—Ä–æ–Ω—É
   - **–ó–∞–ø–∏—Å—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏** –≤ `_force_close_history`
4. **–ì–∞—Ä–∞–Ω—Ç–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è market order –≤–º–µ—Å—Ç–æ limit

### API endpoint:

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É force-close
GET http://localhost:8000/orders/positions/monitor/stats

# –û—Ç–≤–µ—Ç:
{
  "positions_force_closed": 5,
  "force_close_enabled": true,
  "max_hold_seconds": 900,
  "check_interval_seconds": 30,
  "recent_force_closes": [
    {
      "position_id": "pos_123",
      "symbol": "BTCUSDT",
      "age_seconds": 920,
      "timestamp": "2026-01-28T10:30:00"
    }
  ]
}
```

---

## üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï #2: –ù–µ–ø—Ä–µ—Ä—ã–≤–Ω–∞—è —Ä–∞–±–æ—Ç–∞

### –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:
- –¢–æ—Ä–≥–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- –ù–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞

### –†–µ—à–µ–Ω–∏–µ:
**Docker —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω** —Å `restart: unless-stopped` –≤ `docker-compose.yml`:

```yaml
services:
  api:
    restart: unless-stopped  # ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
```

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:

**Event-driven Architecture:**
- –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ **EventBus** (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞)
- –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ø–æ–¥–ø–∏—Å–∞–Ω—ã –Ω–∞ **EventType.TICK** events
- –ù–µ–ø—Ä–µ—Ä—ã–≤–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∏–≥–Ω–∞–ª–æ–≤ —á–µ—Ä–µ–∑ —Å–æ–±—ã—Ç–∏—è

**Error handling:**
- –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏–º–µ—é—Ç `try/except` –±–ª–æ–∫–∏
- –û—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è, –Ω–æ –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç —Å–∏—Å—Ç–µ–º—É
- Graceful shutdown –ø—Ä–∏ SIGTERM/SIGINT

---

## üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï #3: –†–∞–≤–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞–ø–∏—Ç–∞–ª–∞

### –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:
- –ö–∞–ø–∏—Ç–∞–ª —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è **–∞–¥–∞–ø—Ç–∏–≤–Ω–æ** –Ω–∞ –æ—Å–Ω–æ–≤–µ Profit Factor
- –ï—Å–ª–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –Ω–µ —Ç–æ—Ä–≥—É–µ—Ç ‚Üí –ø–æ–ª—É—á–∞–µ—Ç –º–µ–Ω—å—à–µ –∫–∞–ø–∏—Ç–∞–ª–∞
- –ù–µ—Ç –æ–ø—Ü–∏–∏ "—Å—Ç—Ä–æ–≥–æ —Ä–∞–≤–Ω–æ–≥–æ" —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è (1/3 –¥–ª—è 3 —Å—Ç—Ä–∞—Ç–µ–≥–∏–π)

### –†–µ—à–µ–Ω–∏–µ:
–î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–ø—Ü–∏—è **Force Equal Allocation**:

```python
# src/hean/config.py
force_equal_allocation: bool = Field(
    default=False,
    description="Force equal capital allocation (1/N for N strategies)"
)
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:

```bash
# .env
FORCE_EQUAL_ALLOCATION=true  # –í–∫–ª—é—á–∏—Ç—å —Ä–∞–≤–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
```

**–ü–æ–≤–µ–¥–µ–Ω–∏–µ:**
- –ü—Ä–∏ `force_equal_allocation=true`: –∫–∞–∂–¥–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –ø–æ–ª—É—á–∞–µ—Ç **—Ä–æ–≤–Ω–æ 1/N** –∫–∞–ø–∏—Ç–∞–ª–∞
- –ü—Ä–∏ `force_equal_allocation=false` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é): –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–µ—Ç—Ä–∏–∫

**–ü—Ä–∏–º–µ—Ä –¥–ª—è 3 —Å—Ç—Ä–∞—Ç–µ–≥–∏–π:**
```python
# Equal mode (force_equal_allocation=true):
{
  "funding_harvester": 0.333,  # 33.33%
  "basis_arbitrage": 0.333,    # 33.33%
  "impulse_engine": 0.333      # 33.33%
}

# Adaptive mode (force_equal_allocation=false):
{
  "funding_harvester": 0.45,  # 45% (high PF)
  "basis_arbitrage": 0.35,    # 35% (medium PF)
  "impulse_engine": 0.20      # 20% (low PF)
}
```

**–§–∞–π–ª—ã:**
```
src/hean/config.py:
  - force_equal_allocation: bool = False

src/hean/portfolio/allocator.py:
  - update_weights(): –ø—Ä–æ–≤–µ—Ä–∫–∞ force_equal_allocation
  - allocate(): –ø—Ä–æ–≤–µ—Ä–∫–∞ force_equal_allocation
```

---

## üìä –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### Unit Tests:

–°–æ–∑–¥–∞–Ω –ø–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä —Ç–µ—Å—Ç–æ–≤ –¥–ª—è PositionMonitor:

```bash
# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
pytest tests/test_position_monitor.py -v

# –¢–µ—Å—Ç—ã:
‚úì test_position_monitor_initialization
‚úì test_position_monitor_start_stop
‚úì test_force_close_stale_position  # ‚≠ê –ì–ª–∞–≤–Ω—ã–π —Ç–µ—Å—Ç
‚úì test_no_force_close_for_fresh_positions
‚úì test_disable_force_close
‚úì test_get_statistics
‚úì test_set_max_hold_seconds
```

### Integration Tests:

```bash
# –ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã –≤ —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
docker-compose up -d

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ Position Monitor
docker-compose logs -f api | grep "PositionMonitor"

# –û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:
# PositionMonitor initialized: max_hold=900s, check_interval=30s
# Position Monitor started (max_hold=900s)
# PositionMonitor loop started
```

---

## üöÄ –ó–ê–ü–£–°–ö –û–ë–ù–û–í–õ–ï–ù–ù–û–ô –°–ò–°–¢–ï–ú–´

### 1. –û–±–Ω–æ–≤–∏—Ç—å .env –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é:

```bash
# –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–º–µ—Ä
cp .env.example .env

# –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å .env
nano .env
```

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:**
```bash
# Position Monitor (–Ω–æ–≤–æ–µ)
MAX_HOLD_SECONDS=900  # 15 –º–∏–Ω—É—Ç
POSITION_MONITOR_CHECK_INTERVAL=30  # 30 —Å–µ–∫—É–Ω–¥
POSITION_MONITOR_ENABLED=true

# Capital Allocation (–Ω–æ–≤–æ–µ)
FORCE_EQUAL_ALLOCATION=false  # –∏–ª–∏ true –¥–ª—è —Ä–∞–≤–Ω–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è

# –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
TRADING_MODE=paper  # –∏–ª–∏ live
DRY_RUN=false
FUNDING_HARVESTER_ENABLED=true
BASIS_ARBITRAGE_ENABLED=true
IMPULSE_ENGINE_ENABLED=true
```

### 2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã:

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏ —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
docker-compose down

# –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –æ–±—Ä–∞–∑—ã (–µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è –∫–æ–¥)
docker-compose build --no-cache

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—É—é —Å–∏—Å—Ç–µ–º—É
docker-compose up -d

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
docker-compose ps

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
docker-compose logs -f api
```

### 3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:

```bash
# Health check
curl http://localhost:8000/health

# Position Monitor —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
curl http://localhost:8000/orders/positions/monitor/stats

# –û—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏
curl http://localhost:8000/orders/positions

# –û—Ä–¥–µ—Ä–∞
curl http://localhost:8000/orders?status=open
```

---

## üìà –û–ñ–ò–î–ê–ï–ú–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
‚ùå –ü–æ–∑–∏—Ü–∏–∏ –∑–∞–≤–∏—Å–∞—é—Ç –Ω–∞ —á–∞—Å—ã
‚ùå –°–∏—Å—Ç–µ–º–∞ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
‚ùå –ù–µ—Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞–ø–∏—Ç–∞–ª–∞

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
‚úÖ **–ü–æ–∑–∏—Ü–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ 15 –º–∏–Ω—É—Ç**
‚úÖ **–°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ —Å –∞–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–º**
‚úÖ **–†–∞–≤–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞–ø–∏—Ç–∞–ª–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)**
‚úÖ **–ü–æ–ª–Ω–∞—è –Ω–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å —á–µ—Ä–µ–∑ API**

---

## üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ü–†–û–ë–õ–ï–ú

### –ü—Ä–æ–±–ª–µ–º–∞: –ü–æ–∑–∏—Ü–∏–∏ –Ω–µ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å:**
```bash
# 1. Position Monitor —Ä–∞–±–æ—Ç–∞–µ—Ç?
docker-compose logs api | grep "Position Monitor started"

# 2. –ï—Å—Ç—å –ª–∏ –∑–∞–≤–∏—Å—à–∏–µ –ø–æ–∑–∏—Ü–∏–∏?
curl http://localhost:8000/orders/positions

# 3. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ force-close
curl http://localhost:8000/orders/positions/monitor/stats
```

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `POSITION_MONITOR_ENABLED=true` –≤ .env
- –£–º–µ–Ω—å—à–∏—Ç—å `MAX_HOLD_SECONDS` –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏: `docker-compose logs -f api | grep "FORCE-CLOSING"`

### –ü—Ä–æ–±–ª–µ–º–∞: –°–∏—Å—Ç–µ–º–∞ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å:**
```bash
# Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç?
docker-compose ps

# Restart policy –Ω–∞—Å—Ç—Ä–æ–µ–Ω?
docker inspect hean-api | grep -i restart
```

**–†–µ—à–µ–Ω–∏–µ:**
- –£–±–µ–¥–∏—Ç—å—Å—è –≤ `restart: unless-stopped` –≤ docker-compose.yml
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å healthcheck: `docker-compose logs api | grep health`

### –ü—Ä–æ–±–ª–µ–º–∞: –ù–µ—Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å:**
```bash
# –¢–µ–∫—É—â–µ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
curl http://localhost:8000/orders/positions | jq '.[] | .strategy_id'

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
grep FORCE_EQUAL_ALLOCATION .env
```

**–†–µ—à–µ–Ω–∏–µ:**
- –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `FORCE_EQUAL_ALLOCATION=true` –¥–ª—è —Ä–∞–≤–Ω–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
- –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å: `docker-compose restart api`

---

## üìù CHANGELOG

### v2.0 (2026-01-28)

**Added:**
- ‚úÖ PositionMonitor –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–π
- ‚úÖ Force equal allocation –æ–ø—Ü–∏—è –¥–ª—è –∫–∞–ø–∏—Ç–∞–ª–∞
- ‚úÖ API endpoint `/orders/positions/monitor/stats`
- ‚úÖ –ü–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä unit tests –¥–ª—è PositionMonitor

**Changed:**
- ‚úÖ main.py: –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω PositionMonitor
- ‚úÖ config.py: –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- ‚úÖ allocator.py: –ø–æ–¥–¥–µ—Ä–∂–∫–∞ force_equal_allocation

**Fixed:**
- ‚úÖ –ó–∞–≤–∏—Å—à–∏–µ –ø–æ–∑–∏—Ü–∏–∏ —Ç–µ–ø–µ—Ä—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è
- ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
- ‚úÖ –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Ä–∞–≤–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞–ø–∏—Ç–∞–ª–∞

---

## üéØ –ò–¢–û–ì–ò

–í—Å–µ **4 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã** –±—ã–ª–∏ —É—Å–ø–µ—à–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã:

1. ‚úÖ **–û—Ä–¥–µ—Ä–∞ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** —á–µ—Ä–µ–∑ Position Monitor
2. ‚úÖ **–°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ** —Å Docker restart policy
3. ‚úÖ **–°—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É—é—Ç** —á–µ—Ä–µ–∑ Event-driven –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É
4. ‚úÖ **–ö–∞–ø–∏—Ç–∞–ª —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é.

---

## üìû –ü–û–î–î–ï–†–ñ–ö–ê

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏: `docker-compose logs -f api`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å health: `curl http://localhost:8000/health`
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É: `curl http://localhost:8000/orders/positions/monitor/stats`

**–ö–æ–Ω—Ç–∞–∫—Ç—ã:**
- GitHub Issues: https://github.com/anthropics/claude-code/issues
- Documentation: /Users/macbookpro/Desktop/HEAN/README.md
